// UNIFIED SCHEMA - Merged from Current + Phase 1 + Phase 3 + Phase 4
// Generated: 2026-01-23
// Base: Current schema (SQLite)
// Additions: Phase 1 (IFRA), Phase 3 (Gating/Subscriptions), Phase 4 (Moyasar)

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = "file:./dev.db"
}

// ============================================
// ENUMS (Phase 3)
// ============================================

enum SubscriptionTier {
  GUEST    // Not registered (localStorage only)
  FREE     // Registered, limited features
  PREMIUM  // Paid subscription, full access
}

enum SubscriptionStatus {
  ACTIVE
  CANCELED
  EXPIRED
  TRIAL
}

enum PaymentProvider {
  STRIPE
  PADDLE
  MOYASAR  // Phase 4: Added Moyasar
  MANUAL
}

// ============================================
// USER MODEL (Merged: Current + Phase 3)
// ============================================

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  password      String   // Hashed password (KEPT from current)
  name          String?
  image         String?
  bio           String?
  role          String   @default("user")
  statsVerified Boolean  @default(false) @map("stats_verified")
  emailVerified DateTime? @map("email_verified")
  
  // ‚úÖ Phase 3: Subscription & Limits
  subscriptionTier   SubscriptionTier @default(FREE)
  monthlyTestCount   Int              @default(0)
  lastTestReset      DateTime         @default(now())
  
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  // Relations
  favorites     UserFavorite[]
  suggestions   Suggestion[]
  accounts      Account[]      // Phase 3: NextAuth
  sessions      Session[]       // Phase 3: NextAuth
  priceAlerts   PriceAlert[]    // Phase 3
  testHistory   TestHistory[]   // Phase 3
  subscriptions Subscription[]  // Phase 3

  @@index([email])
  @@index([subscriptionTier, monthlyTestCount])
  @@map("users")
}

// ============================================
// AUTHENTICATION (Phase 3: NextAuth Standard)
// ============================================

model Account {
  id                String  @id @default(cuid())
  userId            String
  type              String
  provider          String
  providerAccountId String
  refresh_token     String?
  access_token      String?
  expires_at        Int?
  token_type        String?
  scope             String?
  id_token          String?
  session_state     String?

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([provider, providerAccountId])
  @@index([userId])
}

model Session {
  id           String   @id @default(cuid())
  sessionToken String   @unique
  userId       String
  expires      DateTime
  user         User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
}

model VerificationToken {
  identifier String
  token      String   @unique
  expires    DateTime

  @@unique([identifier, token])
}

// ============================================
// EXISTING MODELS (Current Schema)
// ============================================

model UserPreference {
  id               String   @id @default(cuid())
  sessionId        String   @unique @map("session_id")
  likedPerfumes    String   @default("[]") @map("liked_perfumes")
  dislikedPerfumes String   @default("[]") @map("disliked_perfumes")
  allergyProfile   String   @default("{}") @map("allergy_profile")
  scentDNA         String?  @map("scent_dna")
  isComplete       Boolean  @default(false) @map("is_complete")
  createdAt        DateTime @default(now()) @map("created_at")
  updatedAt        DateTime @updatedAt @map("updated_at")

  @@map("user_preferences")
}

model UserFavorite {
  id        String   @id @default(cuid())
  userId    String   @map("user_id")
  perfumeId String   @map("perfume_id")
  createdAt DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, perfumeId], name: "userId_perfumeId")
  @@map("user_favorites")
}

model Perfume {
  id              String   @id @default(cuid())
  name            String
  brand           String
  image           String
  description     String?
  price           Float?
  baseScore       Int      @default(50)
  scentPyramid    String?  @map("scent_pyramid")
  families        String   @default("[]")
  ingredients     String   @default("[]")
  symptomTriggers String   @default("[]") @map("symptom_triggers")
  isSafe          Boolean  @default(true)
  status          String   @default("safe")
  variant         String?
  createdAt       DateTime @default(now()) @map("created_at")
  updatedAt       DateTime @updatedAt @map("updated_at")

  prices Price[]

  @@map("perfumes")
}

model Store {
  id           Int      @id @default(autoincrement())
  name         String
  slug         String   @unique
  affiliateUrl String
  commission   Float
  isActive     Boolean  @default(true)
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")

  prices Price[]

  @@map("stores")
}

model Price {
  id        Int      @id @default(autoincrement())
  perfumeId String   @map("perfume_id")
  storeId   Int      @map("store_id")
  price     Float
  currency  String   @default("SAR")
  updatedAt DateTime @updatedAt @map("updated_at")

  perfume Perfume @relation(fields: [perfumeId], references: [id], onDelete: Cascade)
  store   Store   @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([perfumeId, storeId])
  @@map("prices")
}

model FragellaPerfume {
  id         String   @id @default(cuid())
  fragellaId String   @unique
  name       String
  brandName  String?
  payloadJson Json
  fetchedAt  DateTime
  expiresAt  DateTime
  
  @@index([fragellaId])
  @@index([name])
  @@map("fragella_perfumes")
}

model FragellaCache {
  id        String   @id @default(cuid())
  key       String   @unique
  data      Json
  expiresAt DateTime
  createdAt DateTime @default(now())
  
  @@index([key])
  @@index([expiresAt])
  @@map("fragella_cache")
}

model Suggestion {
  id           String   @id @default(cuid())
  title        String
  description  String
  category     String   @default("general")
  status       String   @default("pending")
  publicStatus String?  @default("planned")
  userId       String   @map("user_id")
  createdAt    DateTime @default(now()) @map("created_at")
  updatedAt    DateTime @updatedAt @map("updated_at")
  votes        Vote[]
  user         User?    @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("suggestions")
}

model Vote {
  id           String     @id @default(cuid())
  suggestionId String     @map("suggestion_id")
  userId       String     @map("user_id")
  createdAt    DateTime   @default(now()) @map("created_at")
  suggestion   Suggestion @relation(fields: [suggestionId], references: [id], onDelete: Cascade)

  @@unique([suggestionId, userId], name: "suggestionId_userId")
  @@map("votes")
}

// ============================================
// ‚úÖ Phase 1: IFRA MATERIALS
// ============================================

model IfraMaterial {
  id                String   @id @default(cuid())
  name              String   @unique
  nameAr            String?
  casNumber         String?  @unique
  maxConcentration  Float    @default(0.01)
  unit              String   @default("percent")
  category          String   // allergen, sensitizer
  euRegulation      String   @default("EU 2023/1545")
  amendmentVersion  String   @default("IFRA 51")
  productCategory   Int      @default(4) 
  symptoms          String   @default("[]") // JSON array
  description       String?
  createdAt         DateTime @default(now())
  updatedAt         DateTime @updatedAt

  perfumeIngredients PerfumeIngredient[]
  symptomMappings    SymptomIngredientMapping[]

  @@map("ifra_materials")
}

model SymptomIngredientMapping {
  id                String   @id @default(cuid())
  symptom           String   
  symptomAr         String   
  ingredient        String   
  confidence        Float    @default(0.5)
  severity          String   @default("moderate") // mild, moderate, severe
  evidenceLevel     String   @default("moderate") // strong, moderate, weak
  source            String?  
  createdAt         DateTime @default(now())

  ifraMaterial      IfraMaterial @relation(fields: [ingredient], references: [name])

  @@unique([symptom, ingredient])
  @@index([symptom])        // üÜï ÿßŸÑŸÅŸáÿ±ÿ≥ ÿßŸÑŸÖÿ∂ÿßŸÅ
  @@index([ingredient])     // üÜï ÿßŸÑŸÅŸáÿ±ÿ≥ ÿßŸÑŸÖÿ∂ÿßŸÅ
  @@map("symptom_ingredient_mappings")
}

model PerfumeIngredient {
  id                String   @id @default(cuid())
  fragellaId        String
  ingredientName    String
  detectedFrom      String   // top_notes, middle_notes, base_notes, accords
  isAllergen        Boolean  @default(false)
  ifraMaterial      IfraMaterial? @relation(fields: [ingredientName], references: [name])
  
  @@unique([fragellaId, ingredientName])
  @@map("perfume_ingredients")
}

// ============================================
// ‚úÖ Phase 3: VALUE LADDER SYSTEM
// ============================================

model PriceAlert {
  id          String   @id @default(cuid())
  userId      String
  perfumeId   String
  targetPrice Float
  
  isActive    Boolean  @default(true)
  notified    Boolean  @default(false)
  lastChecked DateTime @default(now())
  
  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  
  @@unique([userId, perfumeId])
  @@index([userId, isActive])
  @@index([perfumeId, targetPrice])
  @@index([lastChecked])
}

model Subscription {
  id        String   @id @default(cuid())
  userId    String
  
  tier      SubscriptionTier @default(PREMIUM)
  status    SubscriptionStatus
  
  plan      String
  startDate DateTime @default(now())
  endDate   DateTime
  
  provider           PaymentProvider
  externalId         String?
  paymentMethodId    String?
  
  // ‚úÖ Phase 4: Moyasar-specific fields
  moyasarPaymentId   String?  @unique
  moyasarCustomerId  String?
  moyasarSourceId    String?
  lastPaymentDate    DateTime?
  nextBillingDate    DateTime?
  
  amount             Float
  currency           String   @default("SAR")
  
  canceledAt         DateTime?
  cancelReason       String?
  
  user               User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt          DateTime @default(now())
  updatedAt          DateTime @updatedAt
  
  @@index([userId, status])
  @@index([endDate])
  @@index([externalId])
  @@index([moyasarPaymentId])
  @@index([nextBillingDate])
}

model TestHistory {
  id              String   @id @default(cuid())
  userId          String
  
  likedPerfumes   String   // JSON array stored as String (SQLite compatibility)
  dislikedPerfumes String   // JSON array stored as String
  allergySymptoms String   // JSON array stored as String
  allergyFamilies String   // JSON array stored as String
  
  totalMatches    Int
  topMatchId      String?
  topMatchScore   Float?
  
  scentDNA        String?  // JSON stored as String (SQLite compatibility)
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  createdAt       DateTime @default(now())
  
  @@index([userId, createdAt])
}

model ConversionEvent {
  id        String   @id @default(cuid())
  userId    String?
  
  eventType String
  fromTier  SubscriptionTier?
  toTier    SubscriptionTier?
  
  page      String?
  metadata  String?  // JSON stored as String (SQLite compatibility)
  
  createdAt DateTime @default(now())
  
  @@index([eventType, createdAt])
  @@index([userId])
}
